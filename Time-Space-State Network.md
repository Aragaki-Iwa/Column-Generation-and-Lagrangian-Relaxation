# 时空状态网的构建  
----  

主要针对铁路乘务计划问题中的“绝对时间”约束（用餐时间窗）和“相对时间”约束（相关乘务规则）
两种网络构建方式：时空接续网（connection network）和时空轴线网（time-space network）
前者易于描述“相对时间”约束，但网络规模大（点之间的连接弧的数量多，稠密图）；后者易于处理“绝对时间”约束（稀疏图），但模型中的复杂约束的处理是难点  

----
**想法1：**时空状态网是基于时空轴线网，而时空轴线网中每个车站对应的在沿时间轴上两相邻的点之间都有弧，可被重复覆盖，但很多是无效的，于是会产生很多“过渡”的状态。TSN中每个点可根据运行线划分为起点和终点两种类型，每个点都有所属的唯一的运行弧。而且，可以看到实质上对于一个车站：它沿时间轴上的点，只有一种情况的连接是有效连接：终点和它沿时间轴最近的起点之间的连接。因为其余的连接最终都会被转化为这种连接。所以可以基于此原则构建时空轴线网（不是先建立基本的时空轴线网，之后再合并），优点：可以进一步减少弧的数量，进而在构建时空状态网时，可避免产生“过渡状态”，大大减少“状态”的数量  

**想法2：**从另一角度来看在时空轴线网中引入“状态”维度，实际上和资源约束最短路中的标号，即“Label”是类似的：  
1.“标号”存储了延伸到到当前节点的各个属性的信息，而“状态”也是存储了扩展到当前节点的各属性值；  
2.接续网中的一个点包含多个标号，时空轴线网中的一个点包括多个状态，而所谓的时空状态网只不过是将这些状态展开，形成新的一个维度。二者的区别也正在于此，接续网中，每个点的“标号”会在每次求解子问题的迭代过程中不断更新，上次迭代的“标号”不会被保留，而是被清除，每次迭代都是从零开始产生新的“标号”（尽管有的点的标号会与上次迭代中产生的标号相同，所以这里也存在着重复计算，但几乎没办法避免，因为原问题的求解就是如此迭代），这就等于每次迭代都是求一个带资源约束的最短路问题（至少是NP-complete的，若限制path是elementary的，则是NP-hard的）。而时空状态网，把所有的状态提前枚举出来，这样，虽然也需要迭代求解最短路，但是这里的最短路是普通的最短路问题，具有高效的多项式时间算法，这样每次求解最短路（子问题）的单位时间变大大减少。  
也就是说在时空状态网中通过别的手段，转移了接续网中必须处理的资源约束，使得子问题变简单。（但总的算法的求解效率还得仔细审视对比）  

----
为了结合两种网络的优点，提出**时空状态网(Time-Space-State Network)**（见周学松2016）。
该网络在时空轴线网络的基础上，增加一个维度——“状态”，构成一个三维的网络：时间、空间、状态。
***
**状态**：每个点的状态是指：从源点到当前点满足路径可行约束的可行状态。因此，多数约束都通过时空状态网中点的可行状态来描述，剩下的待处理的约束
只有交路的耦合约束和流平衡约束。  
基于TSSN的车辆路径优化模型的主要思想是将复杂的路径约束从优化模型中转移到网络结构中，用经典的优化方法求解车辆路径问题。而在TSSN中的路径生成问题被转化为经典的最短路问题，具有多项式时间解法。 

---
用餐（午/晚）开始时间 $ t^s_{meal} = max(t_{pre}, Meal_{min}) $  
用餐（午/晚）结束时间 $ t^e_{meal} = min(t_{cur}, Meal_{max}) $  
$$if \, t^e_{meal} - t^s_{meal} \geq Te_{min}$$  
$then$  
$$Mb_{i(m)} =\begin{cases}
1, & when Meal_{min} = S_Lunch and Meal_{max} = E_Lunch \\      
2, & when Meal_{min} = S_Supper and Meal_{max} = E_Supper
\end{cases}
  $$  

$$ 函数名=\begin{cases}
公式1 & 条件1 \\
公式2 & 条件2 \\
公式3 & 条件3 
\end{cases}$$

***
在CSP中，通过**状态**来描述根据“混合时间”约束推算得到的点（task）的可行状态，TSSN的结构适用于拉格朗日松弛来求解
## 问题描述与网络构建  
- 基本的乘务术语就不说了
- 乘务规则  

name                      |expression     |explanation
--------------------------|---------------|-------------
 working time of a duty   | $Td <= Td^{max}$:| 累计工作时间，包括驾驶、换乘、间休
 transfer time            | $Tt >= Tt_{min}$:| 换乘时间
 consecutive driving time | $To <= To^{max}$:| 连续驾驶时间（包括换乘，不包括间休）
 break time               | $Tr >= Tr_{min}$:| 间休时长
 overnight rest time      | $Ts >= Ts_{min}$:| 外驻时间
 the period of a pairing  | $Tp <= Dd$:      | 交路长度（出乘-退乘 的总时长
 meal break time:         | 午餐 $TW^l_{MB} = \[ML_{min}, ML_{max}\]$ and     晚餐 $TW^s_{MB} = \[MS_{min}, MS_{max}\]$ | 此外，用餐时间必须是工作开始后$Te^a_b$小时和工作结束前$Te^b_f$ 小时

前6个：相对时间；第7个：绝对时间
TSSN中，每个点有三个维度$(t,s,\omega)$
点$v_i$的第 m 个状态为$\omega_{i(m)}$，每个状态用5个属性值来表示：$\omega_{i(m)} = (Td_{i(m)},To_{i(m)},Tc_{i(m)},Tp_{i(m)},Mb_{i(m)})$
这样每个点就可以表示为$(t_i,s_i,\omega_{i(m)})$， 点$v_i$的所有状态为$\Omega_i = \{\omega_{i(1)},...\omega_{i{5}}\}$
- 解释：
1. $Td_{i(m)}$：accumulated working time of $v_{i(m)}$  累计工作时间，通过点$v_{i(m)}$的前继节点$v_{j(n)}$计算。点$v_{i(m)}$和点$v_{j(n)}$之间弧的弧长$tt_{j(n),i(m)} = t_i - t_j$  
$Td_{i(m)} = Td_{j(n)} + tt_{j(n),i(m)}$. 若点$v_{j(n)}$是基地，则$Td_{i(m)} = 0$,；若弧是跨天弧，$Td_{i(m)} = 0$
2.$To_{i(m)}$: accumulated consecutive drving time of $v_{i(m)}$ 累计连续驾驶时间
$Tc_{i(m)},Tp_{i(m)},Mb_{i(m)}$


------  

##状态各属性清零条件、转移条件和转移公式 （当前弧($v_{j(m)},v_{i(m)}$)） 

 属性            |  清零条件               | 转移条件| 转移公式
----------------|-------------------------| ------- |-------       
$Td_{i(m)}$     | 1. $v_{i(m)}$是基地     |          |
 回复的          | 2. 弧是跨天弧           |          |   
                |                        |          |
                |                        |          |
                |                        |          |
  

参考文献：A Lagrangian Relaxation Approach 
